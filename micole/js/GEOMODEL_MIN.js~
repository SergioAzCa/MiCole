/* Copyright © 2016 Sergio Aznar Cabotá & Rodrigo Diaz & Cristina Sesé Martínez
   EMPRESA : GEOMODEL (info@geomodel.es) */
proj4.defs("EPSG:25830","+proj=utm +zone=30 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");var Catastro=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"anover:Catastro"},serverType:"geoserver",crossOrigin:"*"});var WMS_Catastro=new ol.layer.Tile({source:Catastro});WMS_Catastro.setVisible(false);WMS_Catastro.set("name","Catastro");WMS_Catastro.setZIndex(2);var PNOA=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"anover:OI.OrthoimageCoverage"},serverType:"geoserver",crossOrigin:"*"});var WMS_PNOA=new ol.layer.Tile({source:PNOA});WMS_PNOA.setVisible(false);WMS_PNOA.set("name","PNOA");var constru=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"pam_sagunto:construcciones"},serverType:"geoserver",crossOrigin:"*"});var WMS0=new ol.layer.Tile({source:constru});WMS0.setZIndex(1);var capa_base=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:capa_base"},serverType:"geoserver",crossOrigin:"*"});var WMS1=new ol.layer.Tile({source:capa_base});WMS1.setOpacity(0.3);WMS1.set("name","WMS1");var centros=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros"},serverType:"geoserver",crossOrigin:"*"});var WMS2=new ol.layer.Tile({source:centros});WMS2.setOpacity(0.7);WMS2.set("name","centros");WMS2.setVisible(false);WMS2.setZIndex(2);var centros_infantil_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_infantil"},serverType:"geoserver",crossOrigin:"*"});var centros_infantil=new ol.layer.Tile({source:centros_infantil_source});centros_infantil.setVisible(false);centros_infantil.set("name","centros_infantil");centros_infantil.setZIndex(2);var centros_primaria_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_primaria"},serverType:"geoserver",crossOrigin:"*"});var centros_primaria=new ol.layer.Tile({source:centros_primaria_source});centros_primaria.setVisible(false);centros_primaria.set("name","centros_primaria");centros_primaria.setZIndex(2);var centros_eso_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_eso"},serverType:"geoserver",crossOrigin:"*"});var centros_eso=new ol.layer.Tile({source:centros_eso_source});centros_eso.setVisible(false);centros_eso.set("name","centros_eso");centros_eso.setZIndex(2);var centros_bachiller_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_bachiller"},serverType:"geoserver",crossOrigin:"*"});var centros_bachiller=new ol.layer.Tile({source:centros_bachiller_source});centros_bachiller.setVisible(false);centros_bachiller.set("name","centros_bachiller");centros_bachiller.setZIndex(2);var distritos_prim_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:distritos_prim"},serverType:"geoserver",crossOrigin:"*"});var distritos_prim=new ol.layer.Tile({source:distritos_prim_source});distritos_prim.setVisible(false);distritos_prim.set("name","distritos_prim");distritos_prim.setZIndex(0);var areas_bach_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:areas_bach"},serverType:"geoserver",crossOrigin:"*"});var areas_bach=new ol.layer.Tile({source:areas_bach_source});areas_bach.setVisible(false);areas_bach.set("name","areas_bach");areas_bach.setZIndex(0);var bing=new ol.layer.Tile({source:new ol.source.BingMaps({imagerySet:"Aerial",key:"AoD-4gLe-rOELtb5sHE6_JaRCBGKoKFzFYZC1kynIMXeJnC8Wvz8XfhnxxPDyZeL"})});var MapQuest=new ol.layer.Tile({style:"Road",source:new ol.source.MapQuest({layer:"osm"})});var source=new ol.source.Vector();var medir=new ol.layer.Vector({source:source,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:1,fill:new ol.style.Fill({color:"red"})})})});var view=new ol.View({center:ol.proj.transform([-0.37,39.465],"EPSG:4326","EPSG:3857"),zoom:13,projection:"EPSG:3857",maxZoom:21,minZoom:11,extent:[-51165.036,4783018.381,-31941.123,4793796.002]});var map=new ol.Map({preload:4,projection:"EPSG:3857",target:"map",controls:[],loadTilesWhileAnimating:true,layers:[new ol.layer.Group({layers:[MapQuest]}),new ol.layer.Group({layers:[WMS_PNOA,distritos_prim,areas_bach,WMS1]}),new ol.layer.Group({layers:[WMS2,centros_infantil,centros_primaria,centros_eso,centros_bachiller],name:"capas"}),new ol.layer.Group({layers:[medir]})],interactions:ol.interaction.defaults({shiftDragZoom:false}),target:"map",view:view});var dragZoom=new ol.interaction.DragZoom({condition:ol.events.condition.always});$(window).load(function(){map.updateSize();wfs();source.clear();map.addOverlay(overlay);map.addLayer(buf_centro);infoAct=true;var c=document.getElementById("tipoCole").value;var b=document.getElementById("portal2").value;var f=document.getElementById("calle").value;funcionBuscarEntrada(b,f,c);var d=$("#x_pos").val();var a=$("#y_pos").val();console.log(d);function e(){loading_loader=jQuery("#loader");loading_loader.css({height:0});loading_loader.css({display:"none"});jQuery("#loader-container").css({display:"none"})}if(c==1){centros_infantil.setVisible(true);$("#capa_21").addClass("capaActiva");$("#visible21").prop("checked",true)}if(c==2){centros_primaria.setVisible(true);$("#capa_22").addClass("capaActiva");$("#visible22").prop("checked",true)}if(c==3){centros_eso.setVisible(true);$("#capa_23").addClass("capaActiva");$("#visible23").prop("checked",true)}if(c==4){centros_bachiller.setVisible(true);$("#capa_24").addClass("capaActiva");$("#visible24").prop("checked",true)}e()});$(document).ready(function(){$(".btnZoomIn").mouseover(function(){$(this).addClass("btnZoomInActivo")});$(".btnZoomIn").mouseout(function(){$(this).removeClass("btnZoomInActivo")});$(".btnZoomIn").click(function(){var b=map.getView();var c=b.constrainResolution(b.getResolution(),1);b.setResolution(c)});$(".btnZoomOut").mouseover(function(){$(this).addClass("btnZoomOutActivo")});$(".btnZoomOut").mouseout(function(){$(this).removeClass("btnZoomOutActivo")});$(".btnZoomOut").click(function(){var b=map.getView();var c=b.constrainResolution(b.getResolution(),-1);b.setResolution(c)});$(".btnZoomCaja").mouseover(function(){$(this).addClass("btnZoomCajaActivo1")});$(".btnZoomCaja").mouseout(function(){$(this).removeClass("btnZoomCajaActivo1")});$(".btnZoomCaja").on("click",function(){$(this).addClass("btnZoomCajaActivo");map.addInteraction(dragZoom);dragZoom.on("boxend",function(){map.removeInteraction(dragZoom);$(".btnZoomCaja").removeClass("btnZoomCajaActivo")})});$(".btnZoomExtension").on("click",function(){map.getView().fit([-51165.036,4783018.381,-31941.123,4793796.002],map.getSize())});$(".btnZoomExtension").mouseover(function(){$(this).addClass("btnZoomExtensionActivo")});$(".btnZoomExtension").mouseout(function(){$(this).removeClass("btnZoomExtensionActivo")});var a=false;$(".btnInfo").mouseover(function(){$(this).addClass("btnInfoActiva1")});$(".btnInfo").mouseout(function(){$(this).removeClass("btnInfoActiva1")})});var contador=0;var iconFeatures2=[];var vectorSource2=new ol.source.Vector({});var prueba2=new ol.layer.Vector({source:vectorSource2});map.addLayer(prueba2);prueba2.setZIndex(2);function areas_bach_1(d,a){var e={LAYERS:"colegios:busqueda_areas_bach",FORMAT:"image/png"};var c=ol.proj.getTransform("EPSG:4326","EPSG:3857");var b=["x:"+d,"y:"+a];e.viewparams=b.join(";");area_influencia_bach=new ol.layer.Tile({source:new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/colegios/wms?",params:e,serverType:"geoserver",crossOrigin:"*"})});map.addLayer(area_influencia_bach)}function areas_prim(d,a){var e={LAYERS:"colegios:busquedas_areas_prim",FORMAT:"image/png"};var c=ol.proj.getTransform("EPSG:4326","EPSG:3857");var b=["x:"+d,"y:"+a];e.viewparams=b.join(";");area_influencia_prim=new ol.layer.Tile({source:new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/colegios/wms?",params:e,serverType:"geoserver",crossOrigin:"*"})});map.addLayer(area_influencia_prim)}function funcionBuscar(){if(contador>0){vectorSource2.clear();iconFeatures2=[]}var b=document.getElementById("input").value;var a=document.getElementById("portal").value;$.ajax({data:{vial:b,portal:a},url:"consulta_portal.php",type:"post",dataType:"json",success:function(f){var l=f[0];var e=parseFloat(l);var i=f[1];var k=parseFloat(i);var j=[e,k];var g=ol.proj.transform(j,"EPSG:25830","EPSG:3857");var h=g[0];console.log(h);var d=g[1];map.getView().setCenter([h,d]);map.getView().setZoom(17);var c=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(j,"EPSG:25830","EPSG:3857"))});iconFeatures2.push(c);vectorSource2.addFeatures(iconFeatures2);contador=1}})}function funcionBuscarEntrada(a,c,b){console.log(b);if(contador>0){vectorSource2.clear();iconFeatures2=[]}$.ajax({data:{calle:c,portal:a},method:"POST",url:"sacaCoord.php",dataType:"json",success:function(i){var s=i[0];var h=s.split(".");var n=parseFloat(h[0]);var g=parseFloat(s);var p=i[1];var o=p.split(".");var l=parseFloat(o[0]);console.log(l);var r=parseFloat(p);var q=[g,r];var k=ol.proj.transform(q,"EPSG:25830","EPSG:3857");var j=k[0];console.log(j);var e=k[1];map.getView().setCenter([j,e]);map.getView().setZoom(17);var d=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(q,"EPSG:25830","EPSG:3857"))});var f=new ol.style.Icon(({anchor:[0.1,1],opacity:1,src:"img/iconos/casa.png",rotation:0,rotateWithView:"true"}));var m=new ol.style.Style({image:f});iconFeatures2.push(d);vectorSource2.addFeatures(iconFeatures2);d.setStyle(m);if(b==1){areas_prim(n,l)}if(b==2){areas_prim(n,l)}if(b==3){areas_bach_1(n,l)}if(b==4){areas_bach_1(n,l)}contador=1}})}var contador_centro=0;function funcionBuscar_centro(){if(contador_centro>0){vectorSource2.clear();iconFeatures2=[]}var a=$("#input2").attr("x");var h=$("#input2").attr("y");console.log(a,h);var c=parseFloat(a);var b=parseFloat(h);var e=[c,b];var f=ol.proj.transform(e,"EPSG:25830","EPSG:3857");var d=f[0];console.log(d);var g=f[1];map.getView().setCenter([d,g]);map.getView().setZoom(17);contador_centro=1}function bindInputs(c,a){var b=$(c+" input.visible");b.on("change",function(){a.setVisible(this.checked)});b.prop("checked",a.getVisible());$.each(["opacity"],function(f,e){var d=$(c+" input."+e);d.on("input change",function(){a.set(e,parseFloat(this.value))});d.val(String(a.get(e)))})}map.getLayers().forEach(function(b,a){bindInputs("#layer"+a,b);if(b instanceof ol.layer.Group){b.getLayers().forEach(function(d,c){bindInputs("#layer"+a+c,d)})}});$("#layertree li > div.deplegaCaracteristicas").click(function(){$(this).siblings("fieldset").toggle()}).siblings("fieldset").hide();function zoom_objeto(){var s=document.getElementById("maxx").value;var g=document.getElementById("maxy").value;var k=document.getElementById("minx").value;var q=document.getElementById("miny").value;var n=[s,g];var l=[k,q];var u=parseFloat(n[0]);var i=parseFloat(n[1]);var t=parseFloat(l[0]);var h=parseFloat(l[1]);var n=[u,i];var l=[t,h];var m=ol.proj.transform(n,"EPSG:25830","EPSG:3857");var r=ol.proj.transform(l,"EPSG:25830","EPSG:3857");var p=m[0];var f=m[1];var j=r[0];var o=r[1];var d=parseFloat(p);var b=parseFloat(f);var e=parseFloat(j);var c=parseFloat(o);var a=[e,c,d,b];map.getView().fit(a,map.getSize())}var myScaleLine=new ol.control.ScaleLine();map.addControl(myScaleLine);var controls=map.getControls();var attributionControl;controls.forEach(function(a){if(a instanceof ol.control.Attribution){attributionControl=a}});map.removeControl(attributionControl);var contador_pop=0;var container=document.getElementById("popup");var content=document.getElementById("popup-content");var closer=document.getElementById("popup-closer");var zoom_pop=document.getElementById("popup-zoom");var popup=true;closer.onclick=function(){overlay.setPosition(undefined);closer.blur();return false};var overlay=new ol.Overlay(({element:container,autoPan:true,autoPanAnimation:{duration:250}}));map.on("singleclick",function(a){var c=a.coordinate;b(c);function b(e){$("#popup-content").html("<div class='loader'></div>");var d=$("#capa").text();console.log(d);if(d=="buf_centro"){var f=$("#Getfeatureinfo").val();$.ajax({data:{id:f},url:"centros.php",type:"post",dataType:"json",success:function(g){content.innerHTML="<div class='encabPopup'><span class='tituloPopUp'>Centro de enseÃ±anza :</span></div><div class='contPopup'> - Nombre: "+g[0]+"<br/>- TelÃ©fono: "+g[1]+"<br/>- Tipo: "+g[2]+"</div>"}})}if(d=="undefined"){overlay.setPosition(undefined)}else{overlay.setPosition(e)}}});map.on("click",function(a){$(".contextMenu").hide()});map.getViewport().addEventListener("contextmenu",function(a){a.preventDefault();openContextMenu(a.x,a.y)});function openContextMenu(a,b){$(".contextMenu").hide();$("body").append('<div class="contextMenu" style=" top: '+b+"px; left:"+a+'px;"><div class="menuItem" onclick="handleContexMenuEvent(\'zoomIn\', \''+a+"', '"+b+"');\"> Zoom + </div><div class=\"menuItem\" onclick=\"handleContexMenuEvent('zoomOut', '"+a+"', '"+b+"');\"> Zoom - </div><div class=\"menuItem\" onclick=\"handleContexMenuEvent('centerMap', '"+a+"', '"+b+'\');"> Centrar el mapa </div><div class="menuItem" onclick="geomodel();"> GEOMODEL </div></div>')}function geomodel(){window.open("http://www.geomodel.es")}function handleContexMenuEvent(d,a,e){$(".contextMenu").hide();var c=map.getCoordinateFromPixel([a,e]);if(d=="zoomIn"){var b=map.getView();b.setZoom(b.getZoom()+1)}else{if(d=="zoomOut"){var b=map.getView();b.setZoom(b.getZoom()-1)}else{if(d=="centerMap"){goToCoord(c[0],c[1])}}}}function goToCoord(a,d){var b=new ol.geom.Point([a,d]).getCoordinates();var c=ol.animation.pan({duration:200,source:map.getView().getCenter()});map.beforeRender(c);map.getView().setCenter(b)}var buf_centro_source=new ol.source.Vector({format:new ol.format.GeoJSON(),url:function(c,b,a){return"http://geomodel.xpress.es:8080/geoserver/wfs?service=WFS&version=1.1.0&request=GetFeature&typename=colegios:buf_centro&outputFormat=application/json&srsname=EPSG:3857&bbox="+c.join(",")+",EPSG:3857"},strategy:ol.loadingstrategy.tile(ol.tilegrid.createXYZ({maxZoom:19}))});var buf_centro=new ol.layer.Vector({source:buf_centro_source,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0)",width:2})})});buf_centro.set("name","buf_centro");var capa="";var prue=[];function wfs(){var a=function(c){var d=map.forEachFeatureAtPixel(c,function(i,h){if(h===undefined){var g="undefined";prue[0]=g;return i}if(h==buf_centro){var g="buf_centro";prue[0]=g;return i}});document.getElementById("capa").innerHTML=prue[0];var b=document.getElementById("capa");var e=document.getElementById("info");if(d){var f=d.get("codigo");console.log(f);document.getElementById("Getfeatureinfo").value=f;document.getElementById("info").innerHTML=f;b="";prue[0]="undefined"}else{e.innerHTML="&nbsp;"}};map.on("pointermove",function(b){if(b.dragging){return}var c=map.getEventPixel(b.originalEvent);a(c)});map.on("click",function(b){a(b.pixel)})}var centros2=new ol.layer.Vector({source:new ol.source.Vector({url:"centros.geojson",format:new ol.format.GeoJSON()}),style:[new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:"white"}),fill:new ol.style.Fill({color:"#1f6b75"}),radius:5})})]});var influencia=new ol.layer.Vector({source:new ol.source.Vector({url:"influencia_prueba.geojson",format:new ol.format.GeoJSON()}),style:[new ol.style.Style({fill:new ol.style.Fill({color:"#1f6b75"})})]});
