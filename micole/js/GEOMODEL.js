function areas_bach_1(e,o){var t={LAYERS:"colegios:busqueda_areas_bach",FORMAT:"image/png"},r=(ol.proj.getTransform("EPSG:4326","EPSG:3857"),["x:"+e,"y:"+o]);t.viewparams=r.join(";"),area_influencia_bach=new ol.layer.Tile({source:new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/colegios/wms?",params:t,serverType:"geoserver",crossOrigin:"*"})}),map.addLayer(area_influencia_bach)}function areas_prim(e,o){var t={LAYERS:"colegios:busquedas_areas_prim",FORMAT:"image/png"},r=(ol.proj.getTransform("EPSG:4326","EPSG:3857"),["x:"+e,"y:"+o]);t.viewparams=r.join(";"),area_influencia_prim=new ol.layer.Tile({source:new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/colegios/wms?",params:t,serverType:"geoserver",crossOrigin:"*"})}),map.addLayer(area_influencia_prim)}function funcionBuscar(){contador>0&&(vectorSource3.clear(),iconFeatures3=[]);var e=document.getElementById("input").value,o=document.getElementById("portal").value;$.ajax({data:{vial:e,portal:o},url:"consulta_portal.php",type:"post",dataType:"json",success:function(e){var o=e[0],t=parseFloat(o),r=e[1],a=parseFloat(r),n=[t,a],s=ol.proj.transform(n,"EPSG:25830","EPSG:3857"),i=s[0],l=s[1];map.getView().setCenter([i,l]),map.getView().setZoom(17);var c=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(n,"EPSG:25830","EPSG:3857"))}),u=new ol.style.Icon({anchor:[.1,1],opacity:1,src:"img/iconos/info_busqueda.png",rotation:0,rotateWithView:"true"}),p=new ol.style.Style({image:u});iconFeatures3.push(c),vectorSource3.addFeatures(iconFeatures3),c.setStyle(p),contador=1}})}function funcionBuscarEntrada(e,o,t,r){contador>0&&(vectorSource2.clear(),iconFeatures2=[]),$.ajax({data:{calle:o,portal:e},method:"POST",url:"sacaCoord.php",dataType:"json",success:function(e){var o=e[0],r=o.split("."),a=parseFloat(r[0]),n=parseFloat(o),s=e[1],i=s.split("."),l=parseFloat(i[0]),c=parseFloat(s),u=[n,c],p=ol.proj.transform(u,"EPSG:25830","EPSG:3857"),m=p[0],d=p[1];map.getView().setCenter([m,d]),map.getView().setZoom(17);var v=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(u,"EPSG:25830","EPSG:3857"))}),g=new ol.style.Icon({anchor:[.1,1],opacity:1,src:"img/iconos/casa.png",rotation:0,rotateWithView:"true"}),y=new ol.style.Style({image:g});iconFeatures2.push(v),vectorSource2.addFeatures(iconFeatures2),v.setStyle(y),1==t&&areas_prim(a,l),2==t&&areas_prim(a,l),3==t&&areas_bach_1(a,l),4==t&&areas_bach_1(a,l),contador=1}}),$.ajax({url:"puntos_centros.php",async:!1,type:"POST",data:{tipo:t,usuario:r},dataType:"json",success:function(e){coordenadas_centros=e;for(var o=coordenadas_centros.length,t=new ol.source.Vector({}),r=0;o>r;r++){var a=coordenadas_centros[r].split(","),n=a[0],s=a[1],i=a[2],l=parseFloat(n),c=parseFloat(s);features[r]=new ol.Feature(new ol.geom.Point(ol.proj.transform([l,c],"EPSG:25830","EPSG:3857")));var u=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([l,c],"EPSG:25830","EPSG:3857"))}),p=new ol.style.Style({fill:new ol.style.Fill({color:"green"}),stroke:new ol.style.Stroke({color:"black",width:1.2}),text:new ol.style.Text({font:"12px Verdana",text:i,textAlign:"center",textBaseline:"middle",stroke:new ol.style.Stroke({color:"white",width:4}),offsetY:-15})});u.setStyle(p),t.addFeature(u)}var m=new ol.layer.Vector({source:t,style:new ol.style.Style({text:new ol.style.Text({font:"50px Verdana",text:i,fill:new ol.style.Fill({color:"black"}),stroke:new ol.style.Stroke({color:"white",width:10})})})});map.addLayer(m),m.setZIndex(2)}})}function funcionBuscar_centro(){var e=$("#input2").attr("x"),o=$("#input2").attr("y"),t=parseFloat(e),r=parseFloat(o),a=[t,r],n=ol.proj.transform(a,"EPSG:25830","EPSG:3857"),s=n[0],i=n[1];map.getView().setCenter([s,i]),map.getView().setZoom(17),contador_centro=1}function bindInputs(e,o){var t=$(e+" input.visible");t.on("change",function(){o.setVisible(this.checked)}),t.prop("checked",o.getVisible()),$.each(["opacity"],function(t,r){var a=$(e+" input."+r);a.on("input change",function(){o.set(r,parseFloat(this.value))}),a.val(String(o.get(r)))})}function zoom_objeto(){var e=document.getElementById("maxx").value,o=document.getElementById("maxy").value,t=document.getElementById("minx").value,r=document.getElementById("miny").value,a=[e,o],n=[t,r],s=parseFloat(a[0]),i=parseFloat(a[1]),l=parseFloat(n[0]),c=parseFloat(n[1]),a=[s,i],n=[l,c],u=ol.proj.transform(a,"EPSG:25830","EPSG:3857"),p=ol.proj.transform(n,"EPSG:25830","EPSG:3857"),m=u[0],d=u[1],v=p[0],g=p[1],y=parseFloat(m),f=parseFloat(d),w=parseFloat(v),_=parseFloat(g),b=[w,_,y,f];map.getView().fit(b,map.getSize())}function openContextMenu(e,o){$(".contextMenu").hide(),$("body").append('<div class="contextMenu" style=" top: '+o+"px; left:"+e+'px;"><div class="menuItem" onclick="handleContexMenuEvent(\'zoomIn\', \''+e+"', '"+o+"');\"> Zoom + </div><div class=\"menuItem\" onclick=\"handleContexMenuEvent('zoomOut', '"+e+"', '"+o+"');\"> Zoom - </div><div class=\"menuItem\" onclick=\"handleContexMenuEvent('centerMap', '"+e+"', '"+o+'\');"> Centrar el mapa </div><div class="menuItem" onclick="geomodel();"> GEOMODEL </div></div>')}function geomodel(){window.open("http://www.geomodel.es")}function handleContexMenuEvent(e,o,t){$(".contextMenu").hide();var r=map.getCoordinateFromPixel([o,t]);if("zoomIn"==e){var a=map.getView();a.setZoom(a.getZoom()+1)}else if("zoomOut"==e){var a=map.getView();a.setZoom(a.getZoom()-1)}else"centerMap"==e&&goToCoord(r[0],r[1])}function goToCoord(e,o){var t=new ol.geom.Point([e,o]).getCoordinates(),r=ol.animation.pan({duration:200,source:map.getView().getCenter()});map.beforeRender(r),map.getView().setCenter(t)}function wfs(){var e=function(e){var o=map.forEachFeatureAtPixel(e,function(e,o){if(void 0===o){var t="undefined";return prue[0]=t,e}if(o==buf_centro){var t="buf_centro";return prue[0]=t,e}});document.getElementById("capa").innerHTML=prue[0];var t=document.getElementById("capa"),r=document.getElementById("info");if(o){var a=o.get("codigo");document.getElementById("Getfeatureinfo").value=a,document.getElementById("info").innerHTML=a,t="",prue[0]="undefined"}else r.innerHTML="&nbsp;"};map.on("pointermove",function(o){if(!o.dragging){var t=map.getEventPixel(o.originalEvent);e(t)}}),map.on("click",function(o){e(o.pixel)})}proj4.defs("EPSG:25830","+proj=utm +zone=30 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");var Catastro=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"anover:Catastro"},serverType:"geoserver",crossOrigin:"*"}),WMS_Catastro=new ol.layer.Tile({source:Catastro});WMS_Catastro.setVisible(!1),WMS_Catastro.set("name","Catastro"),WMS_Catastro.setZIndex(2);var PNOA=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"anover:OI.OrthoimageCoverage"},serverType:"geoserver",crossOrigin:"*"}),WMS_PNOA=new ol.layer.Tile({source:PNOA});WMS_PNOA.setVisible(!1),WMS_PNOA.set("name","PNOA");var constru=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"pam_sagunto:construcciones"},serverType:"geoserver",crossOrigin:"*"}),WMS0=new ol.layer.Tile({source:constru});WMS0.setZIndex(1);var capa_base=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:capa_base"},serverType:"geoserver",crossOrigin:"*"}),WMS1=new ol.layer.Tile({source:capa_base});WMS1.setOpacity(.3),WMS1.set("name","WMS1");var centros=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros"},serverType:"geoserver",crossOrigin:"*"}),WMS2=new ol.layer.Tile({source:centros});WMS2.setOpacity(.7),WMS2.set("name","centros"),WMS2.setVisible(!1),WMS2.setZIndex(2);var centros_infantil_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_infantil"},serverType:"geoserver",crossOrigin:"*"}),centros_infantil=new ol.layer.Tile({source:centros_infantil_source});centros_infantil.setVisible(!1),centros_infantil.set("name","centros_infantil"),centros_infantil.setZIndex(2);var centros_primaria_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_primaria"},serverType:"geoserver",crossOrigin:"*"}),centros_primaria=new ol.layer.Tile({source:centros_primaria_source});centros_primaria.setVisible(!1),centros_primaria.set("name","centros_primaria"),centros_primaria.setZIndex(2);var centros_eso_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_eso"},serverType:"geoserver",crossOrigin:"*"}),centros_eso=new ol.layer.Tile({source:centros_eso_source});centros_eso.setVisible(!1),centros_eso.set("name","centros_eso"),centros_eso.setZIndex(2);var centros_bachiller_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:centros_bachiller"},serverType:"geoserver",crossOrigin:"*"}),centros_bachiller=new ol.layer.Tile({source:centros_bachiller_source});centros_bachiller.setVisible(!1),centros_bachiller.set("name","centros_bachiller"),centros_bachiller.setZIndex(2);var distritos_prim_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:distritos_prim"},serverType:"geoserver",crossOrigin:"*"}),distritos_prim=new ol.layer.Tile({source:distritos_prim_source});distritos_prim.setVisible(!1),distritos_prim.set("name","distritos_prim"),distritos_prim.setZIndex(0);var areas_bach_source=new ol.source.TileWMS({url:"http://geomodel.xpress.es:8080/geoserver/wms?",params:{LAYERS:"colegios:areas_bach"},serverType:"geoserver",crossOrigin:"*"}),areas_bach=new ol.layer.Tile({source:areas_bach_source});areas_bach.setVisible(!1),areas_bach.set("name","areas_bach"),areas_bach.setZIndex(0);var bing=new ol.layer.Tile({source:new ol.source.BingMaps({imagerySet:"Aerial",key:"AoD-4gLe-rOELtb5sHE6_JaRCBGKoKFzFYZC1kynIMXeJnC8Wvz8XfhnxxPDyZeL"})}),/*MapQuest=new ol.layer.Tile({style:"Road",source:new ol.source.MapQuest({layer:"osm"})}),*/source=new ol.source.Vector,medir=new ol.layer.Vector({source:source,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:1,fill:new ol.style.Fill({color:"red"})})})}),view=new ol.View({center:ol.proj.transform([-.37,39.465],"EPSG:4326","EPSG:3857"),zoom:13,projection:"EPSG:3857",maxZoom:21,minZoom:11,extent:[-51165.036,4783018.381,-31941.123,4793796.002]}),map=new ol.Map({preload:4,projection:"EPSG:3857",target:"map",controls:[],loadTilesWhileAnimating:!0,layers:[new ol.layer.Group({layers:[bing]}),new ol.layer.Group({layers:[WMS_PNOA,distritos_prim,areas_bach,WMS1]}),new ol.layer.Group({layers:[WMS2,centros_infantil,centros_primaria,centros_eso,centros_bachiller],name:"capas"}),new ol.layer.Group({layers:[medir]})],interactions:ol.interaction.defaults({shiftDragZoom:!1}),target:"map",view:view}),dragZoom=new ol.interaction.DragZoom({condition:ol.events.condition.always});$(window).load(function(){function e(){loading_loader=jQuery("#loader"),loading_loader.css({height:0}),loading_loader.css({display:"none"}),jQuery("#loader-container").css({display:"none"})}map.updateSize(),wfs(),source.clear(),map.addOverlay(overlay),map.addLayer(buf_centro),infoAct=!0;var o=document.getElementById("tipoCole").value,t=document.getElementById("portal2").value,r=document.getElementById("identificadorCalle").value;console.log(r);var a=document.getElementById("usuario").value;console.log(a),funcionBuscarEntrada(t,r,o,a);$("#x_pos").val(),$("#y_pos").val();1==o&&(centros_infantil.setVisible(!0),$("#capa_21").addClass("capaActiva"),$("#visible21").prop("checked",!0)),2==o&&(centros_primaria.setVisible(!0),$("#capa_22").addClass("capaActiva"),$("#visible22").prop("checked",!0)),3==o&&(centros_eso.setVisible(!0),$("#capa_23").addClass("capaActiva"),$("#visible23").prop("checked",!0)),4==o&&(centros_bachiller.setVisible(!0),$("#capa_24").addClass("capaActiva"),$("#visible24").prop("checked",!0)),e()}),$(document).ready(function(){$(".btnZoomIn").mouseover(function(){$(this).addClass("btnZoomInActivo")}),$(".btnZoomIn").mouseout(function(){$(this).removeClass("btnZoomInActivo")}),$(".btnZoomIn").click(function(){var e=map.getView(),o=e.constrainResolution(e.getResolution(),1);e.setResolution(o)}),$(".btnZoomOut").mouseover(function(){$(this).addClass("btnZoomOutActivo")}),$(".btnZoomOut").mouseout(function(){$(this).removeClass("btnZoomOutActivo")}),$(".btnZoomOut").click(function(){var e=map.getView(),o=e.constrainResolution(e.getResolution(),-1);e.setResolution(o)}),$(".btnZoomCaja").mouseover(function(){$(this).addClass("btnZoomCajaActivo1")}),$(".btnZoomCaja").mouseout(function(){$(this).removeClass("btnZoomCajaActivo1")}),$(".btnZoomCaja").on("click",function(){$(this).addClass("btnZoomCajaActivo"),map.addInteraction(dragZoom),dragZoom.on("boxend",function(){map.removeInteraction(dragZoom),$(".btnZoomCaja").removeClass("btnZoomCajaActivo")})}),$(".btnZoomExtension").on("click",function(){map.getView().fit([-51165.036,4783018.381,-31941.123,4793796.002],map.getSize())}),$(".btnZoomExtension").mouseover(function(){$(this).addClass("btnZoomExtensionActivo")}),$(".btnZoomExtension").mouseout(function(){$(this).removeClass("btnZoomExtensionActivo")});$(".btnInfo").mouseover(function(){$(this).addClass("btnInfoActiva1")}),$(".btnInfo").mouseout(function(){$(this).removeClass("btnInfoActiva1")})});var contador=0,iconFeatures2=[],iconFeatures3=[],vectorSource3=new ol.source.Vector({}),prueba3=new ol.layer.Vector({source:vectorSource3});map.addLayer(prueba3),prueba3.setZIndex(2);var vectorSource2=new ol.source.Vector({}),prueba2=new ol.layer.Vector({source:vectorSource2});map.addLayer(prueba2),prueba2.setZIndex(2);var coordenadas_centros=[],features=[],contador_centro=0;map.getLayers().forEach(function(e,o){bindInputs("#layer"+o,e),e instanceof ol.layer.Group&&e.getLayers().forEach(function(e,t){bindInputs("#layer"+o+t,e)})}),$("#layertree li > div.deplegaCaracteristicas").click(function(){$(this).siblings("fieldset").toggle()}).siblings("fieldset").hide();var myScaleLine=new ol.control.ScaleLine;map.addControl(myScaleLine);var controls=map.getControls(),attributionControl;controls.forEach(function(e){e instanceof ol.control.Attribution&&(attributionControl=e)}),map.removeControl(attributionControl);var contador_pop=0,container=document.getElementById("popup"),content=document.getElementById("popup-content"),closer=document.getElementById("popup-closer"),zoom_pop=document.getElementById("popup-zoom"),popup=!0;closer.onclick=function(){return overlay.setPosition(void 0),closer.blur(),!1};var overlay=new ol.Overlay({element:container,autoPan:!0,autoPanAnimation:{duration:250}});map.on("singleclick",function(e){function o(e){$("#popup-content").html("<div class='loader'></div>");var o=$("#capa").text();if("buf_centro"==o){var t=$("#Getfeatureinfo").val();$.ajax({data:{id:t},url:"centros.php",type:"post",dataType:"json",success:function(e){null==e[5]?content.innerHTML="<div class='encabPopup'><span class='tituloPopUp'>Centro de enseñanza :</span></div><div class='contPopup'> - Nombre: "+e[0]+"<br/>- Teléfono: "+e[1]+"<br/>- Tipo: "+e[2]+"<br/>- Área:No tiene docencia de Bachiller ni de E.S.O <br/>- Distrito: "+e[6]+"</div>":null==e[6]?content.innerHTML="<div class='encabPopup'><span class='tituloPopUp'>Centro de enseñanza :</span></div><div class='contPopup'> - Nombre: "+e[0]+"<br/>- Teléfono: "+e[1]+"<br/>- Tipo: "+e[2]+"<br/>- Área: "+e[5]+"<br/>- Distrito: No tiene docencia de Primaria ni de Infantil</div>":content.innerHTML="<div class='encabPopup'><span class='tituloPopUp'>Centro de enseñanza :</span></div><div class='contPopup'> - Nombre: "+e[0]+"<br/>- Teléfono: "+e[1]+"<br/>- Tipo: "+e[2]+"<br/>- Área: "+e[5]+"<br/>- Distrito: "+e[6]+"</div>"}})}"undefined"==o?overlay.setPosition(void 0):overlay.setPosition(e)}var t=e.coordinate;o(t)}),map.on("click",function(){$(".contextMenu").hide()}),map.getViewport().addEventListener("contextmenu",function(e){e.preventDefault(),openContextMenu(e.x,e.y)});var buf_centro_source=new ol.source.Vector({format:new ol.format.GeoJSON,url:function(e){return"http://geomodel.xpress.es:8080/geoserver/wfs?service=WFS&version=1.1.0&request=GetFeature&typename=colegios:buf_centro&outputFormat=application/json&srsname=EPSG:3857&bbox="+e.join(",")+",EPSG:3857"},strategy:ol.loadingstrategy.tile(ol.tilegrid.createXYZ({maxZoom:19}))}),buf_centro=new ol.layer.Vector({source:buf_centro_source,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0)",width:2})})});buf_centro.set("name","buf_centro");var capa="",prue=[],centros2=new ol.layer.Vector({source:new ol.source.Vector({url:"centros.geojson",format:new ol.format.GeoJSON}),style:[new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:"white"}),fill:new ol.style.Fill({color:"#1f6b75"}),radius:5})})]}),influencia=new ol.layer.Vector({source:new ol.source.Vector({url:"influencia_prueba.geojson",format:new ol.format.GeoJSON}),style:[new ol.style.Style({fill:new ol.style.Fill({color:"#1f6b75"})})]});
